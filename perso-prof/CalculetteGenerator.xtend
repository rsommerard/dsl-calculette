/*
 * generated by Xtext
 */
package fr.univLille1.compil.calculette.generator

import org.eclipse.emf.ecore.resource.Resource
import org.eclipse.xtext.generator.IGenerator
import org.eclipse.xtext.generator.IFileSystemAccess
import fr.univLille1.compil.calculette.calculette.Calculette
import fr.univLille1.compil.calculette.calculette.Expr
import fr.univLille1.compil.calculette.calculette.Calc
import fr.univLille1.compil.calculette.calculette.Number
import org.eclipse.emf.ecore.EObject
import fr.univLille1.compil.calculette.calculette.Var
import fr.univLille1.compil.calculette.calculette.Affect
import fr.univLille1.compil.calculette.calculette.Ligne
import fr.univLille1.compil.calculette.calculette.Ans
import java.util.HashMap

/**
 * Generates code from your model files on save.
 * 
 * see http://www.eclipse.org/Xtext/documentation.html#TutorialCodeGeneration
 */
class CalculetteGenerator implements IGenerator {
    Iterable<Affect> variables
    HashMap<String, CharSequence> stack = new HashMap<String, CharSequence>();
    int stackPointer = 0;
    
	override void doGenerate(Resource resource, IFileSystemAccess fsa) {
		variables = resource.allContents.toIterable.filter(Affect)
		stack.put('#1', '0');
		stack.put('#2', '0');
		stack.put('#3', '0');
		for(c: resource.allContents.toIterable.filter(Calculette))
		   fsa.generateFile(
		   	  "calculette/Calc.java",
		   	  c.compile
		   )
	}
	
	def CharSequence compile(EObject o) {
		switch o {
			Calculette : '''
		package calculette;
		
		public class Calc {
			public static void main(String [ ] args)
				{
					int res = 0;
					«FOR variable:variables»
						int _«variable.name»;
					«ENDFOR»
					«FOR calcs:o.calculs»
						«calcs.compile»
					«ENDFOR»
					System.out.println(res);
				}
			
		}
	'''
	        Ligne : '''«o.e.compile»'''
	        Calc : calcProcess(o)
	        Var : '''_«o.name»'''
            Number : '''«IF o.neg»-«ENDIF»«o.value»'''
	        Ans : '''«stack.get(o.name)»'''
	        Expr : '''(«o.left.compile») «o.op» («o.right.compile»)'''
	        Affect : '''_«o.name» = «o.right.compile»;'''
		}
	}

	def CharSequence calcProcess(Calc o) {
		stackPointer++
		stack.put('#' + stackPointer.toString(), o.e.compile)
		stackPointer = stackPointer % 3
		'''res = «o.e.compile»;'''
	}
}
